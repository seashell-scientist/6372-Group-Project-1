---
title: "6372 EDA moviedata"
author: "Jonathan Tan"
date: "9/17/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r import}
#insert your movie database file here

mdata <- readxl::read_xlsx("D:/SMU/DS 6372 Applied Statistics/Sample Datasets/2014 and 2015 CSM dataset.xlsx")
names(mdata)[14]= "Aggregate_Followers" #the space was interfering with some loops
#names(mdata)


#adding Return as gross/budget, interpret as what % profit the movie made based off its budget
Return <- mdata$Gross/mdata$Budget
mdata <- cbind(mdata, Return)

#trim movie names
mdata <- mdata[,-1]


mdata2 <- read.csv("D:/SMU/DS 6372 Applied Statistics/6372 Group Project 1/6372-Group-Project-1/mdata_imputated.csv")

names(mdata2)[15]= "Aggregate_Followers"

Return <- mdata2$Gross/mdata2$Budget
mdata2 <- cbind(mdata2, Return)

mdata2 <- mdata2[,-1]

#convert year, genre, maybe sequel? to categorical variables for two way anova
mdata3 <- mdata2
mdata3$Genre <- as.factor(mdata3$Genre)
mdata3$Year <- as.factor(mdata3$Year)
mdata3$Sequel <- as.factor(mdata3$Sequel)

#add log of return to normalize for graphs
Return_Log <- log(mdata3$Return)
mdata3  <- cbind(mdata3, Return_Log)

#trunc ratings to create another factor for anova
Round.Ratings <- as.factor(trunc(mdata3$Ratings))
mdata3 <- cbind(mdata3, Round.Ratings)


```

```{r inital visualizations}
library(ggplot2)
library(gridExtra)
p1 <- ggplot(data = mdata, aes(x = Ratings, y = Gross))+
  geom_bin2d(bins = 20)+
  labs(title = "Movie Ratings VS Gross")

p2 <- ggplot(data = mdata2, aes(x = Ratings, y = Gross))+
  geom_bin2d(bins = 20)+
  labs(title = "Movie Ratings VS Gross")+
  scale_fill_gradient(low = "grey", high = "red")

p3 <- ggplot(data = mdata2, aes(x = Ratings, y = Return))+
  geom_bin2d(binwdith = c(2, 2))+
  labs(title = "Movie Ratings VS Profit Ratio")  +
  scale_fill_gradient(low = "grey", high = "red")
                      
p4 <- ggplot(data = mdata2, aes(x = Ratings, y = Return))+
  geom_bin2d(binwdith = c(2, 2))+
  labs(title = "Movie Ratings VS Profit Ratio")  +
  scale_fill_gradient(low = "grey", high = "red", limits = c(0, 16), breaks = seq(0, 16, 4)) +
  ylim(0, 35)
 


p32 <- ggplot(data = mdata2, aes(x = Ratings, y = Return))+
  geom_bin2d(binwdith = c(2, 2))+
  labs(title = "Movie Ratings VS Profit Ratio")  +
  scale_fill_gradient(low = "grey", high = "yellow")
                      
p42 <- ggplot(data = mdata2, aes(x = Ratings, y = Return))+
  geom_bin2d(bins = 30)+
  labs(title = "Movie Ratings VS Profit Ratio(Trim2)")  +
  scale_fill_gradient(low = "grey", high = "yellow", limits = c(0, 16), breaks = seq(0, 16, 4)) +
  ylim(0, 35)
 


grid.arrange(p2, p3, nrow = 1)

grid.arrange(p32, p42, nrow = 1)
```

```{r vis1.5}
p43 <- ggplot(data = mdata2, aes(x = Ratings, y = Return))+
  geom_bin2d(bins = 40)+
  labs(title = "Movie Ratings VS Profit Ratio(Zoom3)")  +
  scale_fill_gradient(low = "gray81", high = "black", limits = c(0, 16), breaks = seq(0, 16, 4)) +
  ylim(0, 10) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = 1), fill = "lightpink", alpha = 0.01) +
  geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = 1, ymax = Inf), fill = "palegreen", alpha = 0.01)
p43
```



```{r vis2}

p1 <- ggplot()+
  geom_histogram(data = mdata, aes(x = Screens, fill = I("Blue")), binwidth = 40) + 
  
  labs(title = "Distribution of Screens")

p2 <- ggplot()+
  geom_line(data = mdata, aes(x = Screens, y = Return))+
  labs(title = "Distribution of Return Ratios")

p3 <- ggplot()+
  geom_histogram(data = mdata2, aes(x = Screens, fill = I("Green")), binwidth = 40) + 
  
  labs(title = "Imputated Screens")

p4 <- ggplot()+
  geom_line(data = mdata2, aes(x = Screens, y = Return, color = "Yellow"))+
  labs(title = "Imputated Return Ratio")






grid.arrange(p1, p2,nrow = 2)
```


```{r vis3}
ggplot(data = mdata, aes(x = Budget, y = Gross, color = factor(Year)))+
  geom_line(linejoin = "round")
 
ggplot(data = mdata, aes(sample = Gross, color = Year))+
  geom_qq()
```

```{r vis4}
#install.packages("ggpubr")
library(ggpubr)
library(magrittr)
ggboxplot(mdata3, x = "Genre", y = "Gross", color = "Year")
ggboxplot(mdata2, x = "Budget", y = "Gross", color = "Genre")
```

```{r vis5}
ggline(mdata, x = "Genre", y = "Return", 
       add = c("mean_se", "dotplot"))
```

roughly positive correlation between gross and rating, screens obviously positively correlates with gross. 

the distribution isn't normal, lots of small presumably indie films that didn't make much gross or have many theater showings, and a few huge blockbusters

high levels of return are genres 3, 8, and 15, with some 1 and 6

```{r check assumptions}
#par(mfrow=(c(2, 2)))
#qqnorm(mdata$Gross, main = "Gross")
#qqnorm(mdata$Budget, main = "Budget")
#
#profit <- mdata$Gross / mdata$Budget
#expense <- mdata$Budget/mdata$Gross
#
#qqnorm(profit, main = " Gross / Budget")
#qqnorm(expense, main = "Budget / Gross")
#
#
#
#qqnorm(log(mdata$Gross), main =  "Log(Gross)")
#qqnorm(log(mdata$Budget), main = "Log(Budget)")
#qqnorm(log(profit), main = " Log(Gross / Budget)" )
#qqnorm(log(expense), main = "Log (Budget / Gross" )

#qqnorm(log(mdata$Gross)/log(mdata$Budget), main = "log Gross / Log Budget")

library(nortest)
ad.test(mdata$Gross)
ad.test(mdata$Return)
ad.test(mdata$Budget)
ad.test(mdata$Aggregate_Followers)
ad.test(mdata$Ratings)
ad.test(mdata$Genre)

ad.test(mdata2$Gross)
ad.test(mdata2$Return)
ad.test(mdata2$Budget)
ad.test(mdata2$Aggregate_Followers)
ad.test(mdata2$Ratings)
ad.test(mdata2$Genre)

```


```{r prelim model2}
m2 <- lm(Gross ~ Budget + Screens + Budget*Screens, data = mdata3)
##with multvar
summary(m2)
layout(matrix(c(1, 2, 3, 4), 2, 2)) 
plot(m2)
```
```{r anova previs}
library(ggpubr)
library(magrittr)
#categorical variables to choose from: Genre, Year, Sequel, (Rating?)


ggboxplot(mdata3, x = "Genre", y = "Return_Log", color = "Year", add = c("mean_se"))+
  labs(title = "Logged Profit Ratios vs Genre for 2014-2015")

ggboxplot(mdata3, x = "Sequel", y = "Return_Log", color = "Year", add = c("mean_se"), palette = rainbow(7))+
  labs(title = "Logged Profit Ratios vs Sequel for 2014-2015")

ggboxplot(mdata3, x = "Round.Ratings", y = "Return_Log", color = "Year", add = c("mean_se"), palette = c("thistle3", "yellowgreen"))+
  labs(title = "Logged Profit Ratios vs Rating for 2014-2015")

ggboxplot(mdata3, x = "Genre", y = "Return_Log", color = "Round.Ratings", add = c("mean_se"), palette = rainbow(7))+
  labs(title = "Logged Profit Ratios vs Rating for 2014-2015")+
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey", size = 0.5)

```

```{r anova thing}
library(dplyr)
library(ggpubr)
library(car)

#genre and year
anov2 <- aov(Return ~ Year  +Genre, data = mdata3)
anov2.2 <- aov(Return ~ Year  *Genre, data = mdata3)

#Sequel and year
anov3 <- aov(Return ~ Year  + Sequel, data = mdata3)

#Ratings and year
anov4 <- aov(Return ~ Year  + Round.Ratings, data = mdata3)

#Genre and Sequel
anov5 <- aov(Return ~ Genre + Sequel, data = mdata3)

#Genre and Ratings
anov6 <- aov(Return ~ Round.Ratings  *Genre, data = mdata3)

#Sequel and ratings
anov7 <- aov(Return ~ Round.Ratings + Sequel, data = mdata3)

#all 4
anov8 <- aov(Return ~ Round.Ratings + Sequel + Genre + Year, data = mdata3)

#all 4 + interactions
anov9 <- aov(Return ~ Round.Ratings + Sequel + Genre + Year + Year*Genre + Year*Sequel + Year*Round.Ratings + Genre*Sequel + Genre*Round.Ratings + Sequel*Round.Ratings, data = mdata3)

#genre, genre*year, ratings*year
anov10 <- aov(Return ~ Genre + Genre*Year + Round.Ratings*Year, data = mdata3)


#all additive
anov11 <- aov(Return ~ Gross + Budget + Year + Ratings + Genre + Screens + Sequel + Sentiment + Views + Likes + Dislikes + Comments + Aggregate_Followers, data = mdata2)
#summary(anov3)

anov.primary <- anov2

Anova(anov.primary, type = "III")
#Anova(anov2.2) #year vs genre, genre and genre*year is significant, but year itself is not
par(mfrow = c(2, 2))
plot(anov.primary)
#Anova(anov3, type = "III")
#Anova(anov4, type = "III")
#Anova(anov5, type = "III")
#Anova(anov6) #
#Anova(anov7)
#Anova(anov8)
#Anova(anov9)
Anova(anov10)
plot(anov10)

#resid1 <- residuals(object = anov.primary)
#shapiro.test(resid1) #use to judge normality, should by higher than alpha?
#shapiro.test(residuals(object = anov2.2))
#shapiro.test(residuals(object = anov2.3))
```



```{r sum stats}
 group_by(mdata3, Genre, Year) %>% 
  summarise(
    count = n(), 
    mean = mean(Return, na.rm = TRUE) ,
    sd = sd(Return, na.rm = TRUE)
  )
#model.tables(anov4, type = "means", se = TRUE) #too long

```
For Gross (unlogged)
looks like genre, budget, screens and ratings are all significant factors, sequel and year:sequel less so


for Return (Gross/Budget), 
looks like genre, genre:year is significant, as is rating:likes
surprisingly not budget? 


```{r train test split}
library(caTools)
set.seed(6548)
sampleset = sample.split(mdata, SplitRatio = 0.8)
mtrain <- subset(mdata, sampleset == TRUE)
mtest = subset(mdata, sampleset == FALSE)

sampleset2 = sample.split(mdata2, SplitRatio = 0.8)
mtrain2 <- subset(mdata2, sampleset2 == TRUE)
mtest2 = subset(mdata2, sampleset2 == FALSE)

sampleset3 = sample.split(mdata3, SplitRatio = 0.8)
mtrain3 <- subset(mdata3, sampleset3 == TRUE)
mtest3 = subset(mdata3, sampleset3 == FALSE)


```

```{r fit model2}
alm1 <- lm(Return ~ Genre + Ratings*Likes + Genre*Year, data = mtrain)

alm2 <- lm(Return ~ Genre + Year, data = mtrain2)
#m3
alm3 <- lm(Return ~ Genre + Screens + Sequel + Year + Ratings + Likes + Sequel*Year + Ratings*Likes + Genre*Year, data = mtrain2)

alm4 <- lm(Return ~ Ratings + Budget + Views + Genre + Year*Genre + Screens, data = mtrain2)

alm5 <- lm(Return ~ Gross + Budget + Year + Ratings + Genre + Screens + Sequel + Sentiment + Views + Likes + Dislikes + Comments + Aggregate_Followers, data = mtrain2)
```

```{r detplot alm2}
alm2 <- alm4

summary(alm2)
par(mfrow = c(2, 2))
plot(alm2)

par(mfrow=c(1,2))
plot(alm2$fitted.values, alm2$residuals, ylab="Resdiduals", xlab="Fitted")
qqnorm(alm2$residuals)

library(gridExtra)
myfits<-data.frame(fitted.values=alm2$fitted.values,residuals=alm2$residuals)

#Residual vs Fitted
plot1<-ggplot(myfits,aes(x=fitted.values,y=residuals))+ylab("Residuals")+
  xlab("Predicted")+geom_point()

#QQ plot of residuals  #Note the diagonal abline is only good for qqplots of normal data.
plot2<-ggplot(myfits,aes(sample=residuals))+
  stat_qq()+geom_abline(intercept=mean(myfits$residuals), slope = sd(myfits$residuals))

#Histogram of residuals
plot3<-ggplot(myfits, aes(x=residuals)) + 
  geom_histogram(aes(y=..density..),binwidth=1,color="black", fill="gray")+
  geom_density(alpha=.1, fill="red")

grid.arrange(plot1, plot2,plot3, ncol=3)

```

```{r apply model?}

#pred1 <- predict(alm2, newdata = mtest2)

#rmse <- sqrt(sum((exp(pred1) - mtest2$Return)^2)/length(mtest2$Return))
##c(RMSE = rmse, R2 = summary(alm2)$r.squared)
#print(paste("RMSE:", rmse))
#print(paste("R^2:", summary(alm2)$r.squared))
##ASE part (average squared error)
#ASE1 <- mean((mtest2$Return - pred1)^2)
#print( paste("Average Squared Error for non-additive model:", ASE1) )
#
#par(mfrow = c(1, 1))
#ggplot()+
#  geom_line(data = mtest2, aes(x = Budget, y = Return), color = "blue")+
#  geom_line(aes(x = mtest2$Budget, y = pred1), color = "red")
  

#plot(mtest$Return, pred1)
```









